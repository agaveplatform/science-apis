##############################################################
#  Development Stack of Dependent Services
#############################################################

##############################################################
# MySQL
##############################################################
version: '3.7'

networks:
  ${project.artifactId}:

services:
  mysql:
    image: bitnami/mariadb:10.3
    environment:
      MARIADB_ROOT_PASSWORD: changeit
      MARIADB_DATABASE: ${foundation.db.database}
      MARIADB_USER: ${foundation.db.username}
      MARIADB_PASSWORD: ${foundation.db.password}
    labels:
      - "traefik.enable=false"
    networks:
      - ${project.artifactId}
    deploy:
      restart_policy:
        condition: on-failure
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  migrate:
    image: agave-migrations:${project.version}
    depends_on:
     - mysql
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: ${foundation.db.username}
      MYSQL_PASSWORD: ${foundation.db.password}
      MYSQL_DATABASE: ${foundation.db.database}
    command: "./flyway migrate"
    networks:
      - ${project.artifactId}